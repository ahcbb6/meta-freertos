parameters:
  buildtype: ''

steps:
- ${{ if eq(parameters.buildtype, 'freertos') }}:
  - bash: |
      echo "Building FreeRTOS image for ${MACHINE}"
      cd ~/poky
      source oe-init-build-env
      echo "${EXTRA_LOCALCONF}" >> ./conf/local.conf

      # Uncomment to disable shared sstate for baremetal build
      # echo "SSTATE_MIRRORS=\"\"" >> ./conf/local.conf
      echo "Building with the following configuration:"
      tail -n 10 conf/local.conf
      if [ -z "${BBTARGET}" ]; then
          export BBTARGET="freertos-demo"
      fi
      echo "Running cmd: bitbake ${BBTARGET}"
      bitbake ${BBTARGET}

    condition: succeededOrFailed()
    displayName: 'Build freertos image'
  - bash: |
      echo "Testing FreeRTOS ${MACHINE}"
      cd ~/poky
      source oe-init-build-env

      # Enable a testcase
      echo "IMAGE_CLASSES += \"testimage\"" >> ./conf/local.conf
      echo "TEST_SUITES = \"freertos_echo\"" >> ./conf/local.conf

      bitbake freertos-demo -c testimage

    displayName: 'Testing FreeRTOS Echo'

- bash: |
    source azp-scripts/azp-helpers.sh
    check_freespace
  condition: succeededOrFailed()
  displayName: 'Post-build space check'

- bash: |
    source azp-scripts/azp-helpers.sh
    rm -rf ${DEPLOY_ARTIFACTS_DIR}/*
    # Kernel BIN
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/freertos-image*.bin ${DEPLOY_ARTIFACTS_DIR}
    # Kernel ELF
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/freertos-image*.elf ${DEPLOY_ARTIFACTS_DIR}
    # QEMUboot
    mv /home/vsts/poky/build/tmp/deploy/images/${MACHINE}/freertos-image-*${MACHINE}-*.qemuboot.conf ${DEPLOY_ARTIFACTS_DIR}
  displayName: 'Moving Artifacts - $(MACHINE)'

- publish: $(DEPLOY_ARTIFACTS_DIR)
  artifact: $(MACHINE)-${{parameters.buildtype}}

- publish: $(SSTATE_DIR)
  artifact: 'SState-${{parameters.buildtype}}'
  condition: succeededOrFailed()
